name: Build Engine SO Multi-Arch

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # MUSL targets (for Alpine/OpenResty)
          - target: x86_64-unknown-linux-musl
            arch_name: amd64
            libc: musl

          - target: aarch64-unknown-linux-musl
            arch_name: arm64
            libc: musl

          # GNU targets (for Debian/Ubuntu images)
          - target: x86_64-unknown-linux-gnu
            arch_name: amd64
            libc: gnu

          - target: aarch64-unknown-linux-gnu
            arch_name: arm64
            libc: gnu

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y file binutils

      # Install cross (uses Docker to build correct toolchains)
      - name: Install cross
        run: cargo install cross --locked

      - name: Cargo Clean
        run: cargo clean

      - name: Build Engine SO for ${{ matrix.target }}
        run: |
          cross build --release --target ${{ matrix.target }}

      - name: Rename Artifact
        run: |
          SRC="target/${{ matrix.target }}/release/libengine.so"
          OUT="libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so"
          cp "$SRC" "$OUT"
          echo "Generated: $OUT"

      - name: Verify ELF + Linkage
        run: |
          file libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          echo "=== Interpreter (musl vs glibc) ==="
          readelf -l libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so | grep -i interpreter || true
          echo "=== Dynamic dependencies (best effort) ==="
          ldd libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so || true

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          path: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Engine Release (latest)
          draft: false
          prerelease: false
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
