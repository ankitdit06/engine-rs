name: Build Engine SO Multi-Arch

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # GLIBC TARGETS
          - target: x86_64-unknown-linux-gnu
            arch_name: amd64
            libc: gnu

          - target: aarch64-unknown-linux-gnu
            arch_name: arm64
            libc: gnu

          # MUSL TARGET (x86_64 only)
          - target: x86_64-unknown-linux-musl
            arch_name: amd64
            libc: musl

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            musl-tools \
            file

      - name: Cargo Clean
        run: cargo clean

      - name: Build Engine SO for ${{ matrix.target }}
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Rename Output
        run: |
          SRC="target/${{ matrix.target }}/release/libengine.so"
          OUT="libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so"
          cp "$SRC" "$OUT"
          echo "Generated: $OUT"

      - name: Verify ELF + Dependencies
        run: |
          file libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          ldd libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so || true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          draft: false
          prerelease: false
          files: |
            libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
