name: Build Engine SO Multi-Arch

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # GLIBC TARGETS (musl doesn't support cdylib/dynamic libraries)
          - target: x86_64-unknown-linux-gnu
            arch_name: amd64
            libc: gnu
            docker_image: debian:bullseye

          - target: aarch64-unknown-linux-gnu
            arch_name: arm64
            libc: gnu
            docker_image: debian:bullseye

    steps:
      - uses: actions/checkout@v4

      # -----------------------------
      # Build in Docker with older GLIBC base image
      # -----------------------------
      - name: Build Engine SO for ${{ matrix.target }}
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e TARGET="${{ matrix.target }}" \
            -e ARCH_NAME="${{ matrix.arch_name }}" \
            -e LIBC="${{ matrix.libc }}" \
            ${{ matrix.docker_image }} \
            bash -c '
              set -e
              # Install Rust
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
              source $HOME/.cargo/env
              
              # Install cross-compilation tools
              apt-get update
              apt-get install -y \
                gcc-aarch64-linux-gnu \
                g++-aarch64-linux-gnu \
                binutils \
                file \
                curl
              
              # Configure cross-linker for ARM64
              if [ "$TARGET" = "aarch64-unknown-linux-gnu" ]; then
                mkdir -p .cargo
                echo "[target.aarch64-unknown-linux-gnu]" > .cargo/config.toml
                echo "linker = \"aarch64-linux-gnu-gcc\"" >> .cargo/config.toml
                echo "ar = \"aarch64-linux-gnu-ar\"" >> .cargo/config.toml
              fi
              
              # Add target and build
              rustup target add "$TARGET"
              cargo build --release --target "$TARGET"
              
              # Copy output
              cp "target/$TARGET/release/libengine.so" "libengine-$ARCH_NAME-$LIBC.so"
              
              # Verify
              echo "=== File info ==="
              file "libengine-$ARCH_NAME-$LIBC.so"
              echo "=== GLIBC version requirements ==="
              objdump -T "libengine-$ARCH_NAME-$LIBC.so" | grep GLIBC || true
              echo "=== Dynamic dependencies ==="
              ldd "libengine-$ARCH_NAME-$LIBC.so" || true
            '

      # -----------------------------
      # Upload artifact for later release
      # -----------------------------
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          path: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4

      # -----------------------------
      # Download all artifacts
      # -----------------------------
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # -----------------------------
      # Create or update GitHub Release
      # -----------------------------
      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Engine Release (latest)
          draft: false
          prerelease: false
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
