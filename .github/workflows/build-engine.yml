name: Build Engine SO Multi-Arch

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # GLIBC TARGETS (musl doesn't support cdylib/dynamic libraries)
          - target: x86_64-unknown-linux-gnu
            arch_name: amd64
            libc: gnu

          - target: aarch64-unknown-linux-gnu
            arch_name: arm64
            libc: gnu

    steps:
      - uses: actions/checkout@v4

      # -----------------------------
      # Install Rust for target
      # -----------------------------
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # -----------------------------
      # Install necessary compilers
      # -----------------------------
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils \
            file

      # -----------------------------
      # Create cross-compilation config for ARM64
      # -----------------------------
      - name: Configure Cross Linkers
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' > .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml
          echo 'ar = "aarch64-linux-gnu-ar"' >> .cargo/config.toml

      # -----------------------------
      # Clean before build
      # -----------------------------
      - name: Cargo Clean
        run: cargo clean

      # -----------------------------
      # Build shared library (.so)
      # -----------------------------
      - name: Build Engine SO for ${{ matrix.target }}
        run: |
          cargo build --release --target ${{ matrix.target }}

      # -----------------------------
      # Package artifact with name including arch+libc
      # -----------------------------
      - name: Rename Artifact
        run: |
          SRC="target/${{ matrix.target }}/release/libengine.so"
          OUT="libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so"
          cp "$SRC" "$OUT"
          echo "Generated: $OUT"

      # -----------------------------
      # Verify ELF and dependencies
      # -----------------------------
      - name: Verify ELF + Dependencies
        run: |
          file libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          echo "=== GLIBC version requirements ==="
          objdump -T libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so | grep GLIBC || true
          echo "=== Dynamic dependencies ==="
          ldd libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so || true

      # -----------------------------
      # Upload artifact for later release
      # -----------------------------
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          path: libengine-${{ matrix.arch_name }}-${{ matrix.libc }}.so
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4

      # -----------------------------
      # Download all artifacts
      # -----------------------------
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # -----------------------------
      # Create or update GitHub Release
      # -----------------------------
      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Engine Release (latest)
          draft: false
          prerelease: false
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
